DROP DATABASE IF EXISTS stocks_market;
CREATE DATABASE IF NOT EXISTS stocks_market;
USE stocks_market;

-- create tables
DROP TABLE IF EXISTS stocks;
CREATE TABLE IF NOT EXISTS stocks (
	id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	ticker VARCHAR(15) NOT NULL UNIQUE,
	name VARCHAR(255) NOT NULL UNIQUE,
	
	INDEX (ticker),
	INDEX (name)
);

DROP TABLE IF EXISTS deal;
CREATE TABLE IF NOT EXISTS deal (
	id SERIAL,
	stock_id BIGINT UNSIGNED NOT NULL,
	`datetime` DATETIME(3) DEFAULT NOW(3),
	price DOUBLE(16, 6) UNSIGNED NOT NULL,
	volume BIGINT UNSIGNED NOT NULL,
	operation ENUM('BUY', 'SELL') NOT NULL,
	
	FOREIGN KEY (stock_id) REFERENCES stocks(id)
);

DROP TABLE IF EXISTS dividends;
CREATE TABLE IF NOT EXISTS dividends(
	id SERIAL,
	stock_id BIGINT UNSIGNED NOT NULL,
	`date` DATE NOT NULL,
	pay DOUBLE(18,8) UNSIGNED NOT NULL,
	period VARCHAR(255) NOT NULL,
		
	FOREIGN KEY (stock_id) REFERENCES stocks(id)
);

DROP TABLE IF EXISTS sectors; 
CREATE TABLE IF NOT EXISTS sectors(
	id SERIAL,
	name VARCHAR(50) UNIQUE NOT NULL,
	
	INDEX sector(name)
);

DROP TABLE IF EXISTS info;
CREATE TABLE IF NOT EXISTS info(
	id SERIAL,
	stock_id BIGINT UNSIGNED NOT NULL,
	sector_id BIGINT UNSIGNED NOT NULL,
	full_name VARCHAR(255) NOT NULL,
	production_volume BIGINT UNSIGNED NOT NULL,
	ceo VARCHAR(255) NOT NULL,
	
	FOREIGN KEY (stock_id) REFERENCES stocks(id),
	FOREIGN KEY (sector_id) REFERENCES sectors(id)
);

DROP TABLE IF EXISTS pay_history;
CREATE TABLE IF NOT EXISTS pay_history(
	id SERIAL,
	stock_id BIGINT UNSIGNED NOT NULL,
	date_pay DATE NOT NULL,
	pay DOUBLE(18,8) UNSIGNED NOT NULL,
	
	FOREIGN KEY (stock_id) REFERENCES stocks(id)
);

DROP TABLE IF EXISTS logs;
CREATE TABLE logs (
	id SERIAL,
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
	table_name ENUM ('deal', 'dividends', 'info', 'pay_history', 'sectors', 'stocks') NOT NULL,
	pk_id BIGINT NOT NULL
) ENGINE = Archive;


-- upload data
INSERT INTO stocks (ticker , name) VALUES
	('SBER', 'Сбербанк'),
	('GAZP', 'Газпром'),
	('GMKN', 'ГМКНорНикель'),
	('LKOH', 'Лукойл'),
	('YNDX', 'Яндекс'),
	('TATN', 'Татнефть'),
	('ROSN', 'Роснефть'),
	('PLZL', 'Полюс Золото'),
	('NLMK', 'НЛМК'),
	('MAGN', 'ММК'),
	('AFSK', 'Система'),
	('POLY', 'Полиметал'),
	('MOEX', 'МосБиржа');

INSERT INTO deal (stock_id, `datetime`, price, volume, operation) VALUES
    ('1', '2016-07-02 03:26:48.000', '240.173638', '83933', 'BUY'),
    ('1', '2020-02-19 13:18:14.000', '246.447000', '64774', 'SELL'),
    ('1', '2016-08-30 18:30:34.000', '246.426421', '5838', 'SELL'),
    ('1', '2019-08-01 07:41:53.000', '242.021090', '4600', 'SELL'),
    ('1', '2019-05-13 15:12:00.000', '203.000000', '177630', 'SELL'),
    ('1', '2015-08-02 20:35:10.000', '220.443000', '3855', 'SELL'),
    ('1', '2018-10-20 17:54:46.000', '237.500000', '7582', 'BUY'),
    ('1', '2020-04-05 15:43:08.000', '218.813000', '55446', 'BUY'),
    ('1', '2020-01-02 17:11:35.000', '207.924837', '1451', 'BUY'),
    ('2', '2020-02-06 07:37:48.000', '220.891351', '8516', 'BUY'),
    ('2', '2018-02-18 16:54:04.000', '172.908000', '79915', 'SELL'),
    ('2', '2015-02-28 06:17:36.000', '230.829520', '7590', 'BUY'),
    ('2', '2017-11-12 14:47:17.000', '162.342000', '29845', 'SELL'),
    ('2', '2020-01-19 02:16:13.000', '227.224470', '12043', 'SELL'),
    ('2', '2015-08-15 03:06:12.000', '192.600000', '64427', 'SELL'),
    ('2', '2015-05-21 07:55:18.000', '239.268000', '237841', 'SELL'),
    ('2', '2018-03-23 19:35:21.000', '233.601595', '30957', 'SELL'),
    ('2', '2017-02-24 23:20:36.000', '214.979096', '6865', 'BUY'),
    ('2', '2020-06-04 15:28:39.000', '175.924320', '9916', 'SELL'),
    ('2', '2019-11-13 07:10:43.000', '235.840674', '67505', 'SELL'),
    ('2', '2016-08-24 00:20:10.000', '165.889455', '57168', 'SELL'),
    ('2', '2017-04-10 22:05:21.000', '238.417000', '67531', 'BUY'),
    ('3', '2015-10-26 22:58:10.000', '21492.579000', '470', 'BUY'),
    ('3', '2020-07-02 17:59:42.000', '17092.641900', '964', 'BUY'),
    ('3', '2017-05-11 08:25:37.000', '15718.933610', '762', 'BUY'),
    ('3', '2020-08-24 01:15:06.000', '18701.530021', '819', 'SELL'),
    ('3', '2019-04-19 08:26:31.000', '21265.492559', '308', 'SELL'),
    ('3', '2015-05-19 23:41:33.000', '20349.530576', '740', 'BUY'),
    ('3', '2020-03-31 00:00:22.000', '24259.211793', '576', 'SELL'),
    ('3', '2016-05-21 19:57:36.000', '18473.000000', '956', 'SELL'),
    ('3', '2020-09-13 02:56:29.000', '18644.342108', '1252', 'BUY'),
    ('4', '2018-08-08 06:13:30.000', '5997.246524', '1309', 'SELL'),
    ('4', '2018-06-14 08:23:40.000', '4723.780000', '852', 'BUY'),
    ('4', '2015-12-03 00:01:14.000', '4385.501000', '14670', 'SELL'),
    ('4', '2016-07-12 03:18:26.000', '5298.781223', '6174', 'SELL'),
    ('4', '2018-01-14 06:42:41.000', '5620.515853', '7591', 'BUY'),
    ('4', '2020-11-16 18:29:41.000', '5288.800000', '3846', 'BUY'),
    ('4', '2015-06-14 17:42:25.000', '5765.000000', '7663', 'BUY'),
    ('4', '2015-10-22 21:31:21.000', '4977.950000', '834', 'SELL'),
    ('4', '2020-01-20 09:07:33.000', '4373.648300', '823', 'BUY'),
    ('4', '2020-03-30 02:06:50.000', '4021.000000', '1010', 'SELL'),
    ('5', '2019-07-13 07:30:54.000', '5187.295348', '794', 'SELL'),
    ('5', '2015-11-26 14:37:58.000', '4361.453230', '216', 'SELL'),
    ('5', '2018-10-05 03:18:44.000', '4022.832990', '241', 'SELL'),
    ('5', '2019-07-19 15:30:48.000', '6156.449090', '1229', 'BUY'),
    ('5', '2019-11-26 16:55:01.000', '6026.508860', '291', 'SELL'),
    ('5', '2019-08-28 02:31:47.000', '4856.119300', '869', 'BUY'),
    ('5', '2017-10-07 20:45:27.000', '3687.107582', '976', 'SELL'),
    ('6', '2015-01-09 13:27:00.000', '580.632760', '6143', 'BUY'),
    ('6', '2016-06-06 09:04:36.000', '532.317300', '3061', 'BUY'),
    ('6', '2019-12-01 03:18:37.000', '556.000000', '5804', 'BUY'),
    ('6', '2019-08-28 04:52:36.000', '353.154300', '7815', 'SELL'),
    ('6', '2019-06-02 19:41:08.000', '436.000000', '2112', 'BUY'),
    ('6', '2017-11-19 04:27:32.000', '354.554357', '3074', 'BUY'),
    ('7', '2020-08-07 02:17:27.000', '442.200000', '3076', 'BUY'),
    ('7', '2017-10-23 11:43:10.000', '328.304400', '556', 'BUY'),
    ('7', '2015-08-25 00:34:50.000', '347.000000', '55138', 'BUY'),
    ('7', '2016-08-07 17:50:42.000', '345.769774', '3728', 'SELL'),
    ('7', '2014-04-05 04:21:51.000', '360.105965', '80232', 'SELL'),
    ('7', '2014-08-29 04:52:44.000', '369.000000', '87310', 'BUY'),
    ('8', '2019-11-23 19:04:51.000', '13994.720000', '920', 'SELL'),
    ('8', '2018-03-09 19:37:32.000', '14138.688170', '509', 'SELL'),
    ('8', '2020-03-05 02:07:42.000', '11038.473090', '357', 'SELL'),
    ('8', '2014-02-07 10:52:59.000', '12724.260000', '93', 'SELL'),
    ('8', '2015-01-12 16:56:01.000', '18533.448815', '58', 'SELL'),
    ('9', '2016-01-07 10:50:11.000', '120.541702', '71829', 'SELL'),
    ('9', '2017-03-03 15:45:38.000', '96.890979', '3248', 'SELL'),
    ('9', '2019-02-23 21:15:48.000', '151.019497', '60707', 'BUY'),
    ('9', '2016-04-05 03:08:51.000', '139.247462', '83523', 'SELL'),
    ('9', '2015-02-28 10:12:43.000', '179.519635', '3313', 'BUY'),
    ('9', '2015-03-02 11:02:56.000', '214.597376', '68721', 'BUY'),
    ('9', '2019-10-21 08:34:45.000', '225.000000', '12818', 'BUY'),
    ('9', '2019-08-22 07:23:57.000', '195.430700', '63959', 'SELL'),
    ('10', '2015-11-03 17:27:45.000', '21.177605', '973217', 'BUY'),
    ('10', '2015-08-27 00:44:17.000', '16.034000', '75026', 'SELL'),
    ('10', '2020-08-01 13:44:14.000', '47.870000', '196459', 'SELL'),
    ('10', '2018-09-20 23:19:18.000', '51.710000', '379925', 'SELL'),
    ('11', '2019-02-24 22:02:00.000', '42.670500', '165941', 'BUY'),
    ('11', '2016-04-02 23:06:46.000', '28.496895', '192687', 'BUY'),
    ('11', '2019-10-13 04:30:10.000', '22.380000', '805758', 'SELL'),
    ('11', '2020-05-24 22:35:45.000', '10.647964', '920242', 'SELL'),
    ('11', '2017-05-04 16:54:39.000', '39.103700', '46191', 'BUY'),
    ('11', '2015-10-29 17:34:27.000', '12.428430', '177968', 'BUY'),
    ('11', '2015-11-25 07:15:32.000', '26.660000', '715773', 'BUY'),
    ('11', '2019-06-06 06:31:57.000', '18.981100', '7265', 'BUY'),
    ('11', '2017-12-20 22:57:45.000', '9.266137', '74515', 'SELL'),
    ('11', '2016-06-17 00:42:59.000', '45.000000', '198285', 'SELL'),
    ('12', '2016-04-30 23:41:44.000', '1073.209613', '4539', 'BUY'),
    ('12', '2015-05-31 19:56:52.000', '239.000000', '3533', 'SELL'),
    ('12', '2015-07-06 02:45:39.000', '1143.360980', '416', 'BUY'),
    ('12', '2019-11-01 10:13:01.000', '1151.180000', '4018', 'BUY'),
    ('12', '2018-10-05 02:34:07.000', '472.178515', '517', 'SELL'),
    ('12', '2013-08-26 12:42:01.000', '781.714900', '33710', 'SELL'),
    ('13', '2019-02-15 11:06:35.000', '142.796000', '30456', 'BUY'),
    ('13', '2018-07-27 13:34:34.000', '67.127000', '39672', 'BUY'),
    ('13', '2018-12-04 10:12:11.000', '143.986164', '9464', 'BUY'),
    ('13', '2015-02-21 15:30:21.000', '55.836652', '491132', 'SELL'),
    ('13', '2017-09-05 15:15:11.000', '87.899380', '45944', 'SELL'),
    ('13', '2017-09-16 08:31:52.000', '125.970000', '26457', 'SELL');
	
INSERT INTO dividends (stock_id, `date`, pay, period) VALUES
	(1, '2021.10.05', 15.6, 'годовые'),
	(2, '2021.07.16', 8.29, 'годовые'),
	(3, '2020.12.24', 623.35, '2ое полугодие'),
	(3, '2021.05.25', 1125.28, '1ое полугодие'),
	(3, '2021.10.07', 1173.49, '2ое полугодие'),
	(4, '2020.12.18', 46, '2ое полугодие'),
	(4, '2021.07.10', 268.51, '1ое полугодие'),
	(6, '2021.01.20', 13.5, '4ый квартал'),
	(6, '2021.06.30', 13.5, '1ый квартал'),
	(6, '2021.10.12', 27.85, '2ой квартал'),
	(7, '2021.06.15', 10.84, '1ое полугодие'),
	(7, '2021.10.11', 12.53, '2ое полугодие'),
	(8, '2021.06.10', 337.49, '1ое полугодие'),
	(8, '2021.10.20', 250.26, '2ое полугодие'),
	(9, '2020.12.29', 6.43, '4ый квартал'),
	(9, '2021.06.09', 3.75, '1ый квартал'),
	(9, '2021.07.13', 4.17, '2ой квартал'),
	(9, '2021.10.12', 4.17, '3ый квартал'),
	(10, '2021.01.14', 2.39, '1ый квартал'),
	(10, '2021.06.17', 1.43, '2ой квартал'),
	(10, '2021.06.20', 0.9994, '3ый квартал'),
	(10, '2021.09.23', 0.9994, '4ый квартал'),
	(11, '2021.07.16', 0.26, 'годовые'),
	(12, '2021.05.11', 71.09, '1ое полугодие'),
	(12, '2021.11.04', 62.33, '2ое полугодие'),
	(13, '2021.05.15', 14.83, 'годовые');

INSERT INTO sectors (name) VALUES
	('Банки и финансы'),
	('Нефть и газ'),
	('Металлы и добыча'),
	('Потребительский сектор');

INSERT INTO info (stock_id, sector_id, full_name, production_volume, ceo) VALUES
	(1, 1, 'Сбербанк России ПАО ао', 21586948000, 'Греф Герман Оскарович'),
	(2, 2, 'Газпром ПАО ао', 23673512900, 'Миллер Алексай Борисович'),
	(3, 3, 'ГМК Норильский Никель ПАО ао', 158245476, 'Потанин Владимир Олегович'),
	(4, 2, 'НК Лукойл ПАО ао', 692865762, 'Алекперов Вагит Юсуфович'),
	(5, 4, 'PLLC Yandex N.V. class A shs', 320430479, 'Волож Аркадий Юрьевич'),
	(6, 2, 'ПАО Татнефть ао', 2178690700, 'Маганов Наиль Ульфатович'),
	(7, 2, 'ПАО НК Роснефть', 10598177817, 'Сечин Игорь Иванович'),
	(8, 3, 'Полюс ПАО ао', 134261084, 'Керимов Абусайд Сулейманович'),
	(9, 3, 'ПАО НЛМК ао', 5993227240, 'Воротников Вячеслав Иванович'),
	(10, 3, 'Магнитогорский металлургический комбинат ПАО ао', 11174330000, 'Рашников Виктор Филиппович'),
	(11, 1, 'АФК Система ПАО ао', 9650000000, 'Евтушенков Владимир Петрович'),
	(12, 3, 'Polymetal International plc', 471818000, 'Несис Виталий Натанович'),
	(13, 1, 'ПАО Московская Биржа', 2276401485, 'Денисов Юрий Олегович');

INSERT INTO pay_history (stock_id, date_pay, pay) VALUES
	(1, '2018.06.26', 12),
	(1, '2019.06.13', 16),
	(1, '2020.10.05', 18.7),
	(2, '2018.07.19', 8.04),
	(2, '2019.07.18', 16.61),
	(2, '2020.07.16', 15.24),
	(3, '2018.07.17', 607.98),
	(3, '2018.10.01', 776.02),
	(3, '2019.06.21', 792.52),
	(3, '2019.10.07', 883.93),
	(3, '2019.12.27', 604.09),
	(3, '2020.05.25', 557.2),
	(4, '2018.07.11', 130),
	(4, '2018.12.21', 95),
	(4, '2019.07.09', 155),
	(4, '2019.12.20', 192),
	(4, '2020.07.10', 350),
	(6, '2018.07.06', 12.16),
	(6, '2018.10.12', 30.27),
	(6, '2019.01.09', 22.26),
	(6, '2019.07.05', 32.38),
	(6, '2019.09.27', 40.11),
	(6, '2019.12.30', 24.36),
	(6, '2020.10.20', 9.94),
	(7, '2018.07.02', 6.65),
	(7, '2018.10.09', 14.58),
	(7, '2019.06.17', 11.33),
	(7, '2019.10.11', 15.34),
	(7, '2020.06.15', 18.07),
	(8, '2018.06.10', 147.12),
	(8, '2018.10.18', 131.11),
	(8, '2019.05.16', 143.62),
	(8, '2019.10.10', 162.98),
	(8, '2020.08.28', 244.75),
	(8, '2020.10.20', 240.18),
	(9, '2018.01.09', 6.04),
	(9, '2018.06.20', 3.36),
	(9, '2018.06.20', 5.73),
	(9, '2018.10.12', 5.24),
	(9, '2019.01.09', 6.04),
	(9, '2019.05.06', 5.8),
	(9, '2019.06.19', 7.34),
	(9, '2019.10.10', 3.68),
	(9, '2020.01.09', 3.22),
	(9, '2020.06.09', 3.12),
	(9, '2020.07.13', 3.21),
	(9, '2020.10.12', 4.75),
	(10, '2018.06.13', 0.806),
	(10, '2018.06.25', 0.801),
	(10, '2018.10.09', 1.59),
	(10, '2018.12.18', 2.11),
	(10, '2019.06.11', 1.4),
	(10, '2019.06.20', 1.49),
	(10, '2019.10.15', 0.69),
	(10, '2020.01.15', 1.65),
	(10, '2020.06.17', 1.51),
	(10, '2020.09.23', 0.607),
	(11, '2018.07.19', 0.11),
	(11, '2019.07.18', 0.11),
	(11, '2020.07.16', 0.13);



































































































































































































































































